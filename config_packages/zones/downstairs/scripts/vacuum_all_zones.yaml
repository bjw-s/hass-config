---
vacuum_downstairs:
  alias: Vacuum all downstairs rooms
  mode: single
  sequence:
    - service: script.turn_on
      target:
        entity_id: script.vacuum_clean_segments_message
      data:
        variables:
          vacuum: livingroom
          segments: |
            {{expand("group.downstairs_vacuum_rooms") | selectattr("state","eq","on") | map(attribute="attributes.valetudo_segment_id") | list | to_json}}

vacuum_clean_segments_message:
  alias: vacuum_clean_segments_message
  sequence:
  - service: mqtt.publish
    data:
      topic: valetudo/{{vacuum}}/MapSegmentationCapability/clean/set
      payload_template: '{"segment_ids": {{segments}}}'
  mode: single
