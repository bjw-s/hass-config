---
id: hallway_doorbell_triggered
alias: Hallway - Doorbell triggered

mode: single
max_exceeded: silent

trigger:
  platform: mqtt
  topic: frigate/events
  payload: frontdoor
  value_template: "{{ value_json['after']['camera'] }}"

variables:
  # The external url for the Home Assistant instance
  base_url: ""
  # Frigate event ID
  id: "{{ trigger.payload_json['after']['id'] }}"
  # Frigate event type
  type: "{{ trigger.payload_json['type'] }}"
  # Camera name in Frigate
  camera: frontdoor
  # Notification target
  notify_device: mobile_app_iphone_bernd_ios
  # Rate limit the automation to once per 30 seconds
  cooldown: 30

condition:
  - "{{ type != 'end' }}"

action: 
  - wait_for_trigger:
      - platform: state
        entity_id: binary_sensor.house_doorbell
        from: 'off'
        to: 'on'
    timeout:
      minutes: 1
    continue_on_timeout: false

  - service: "notify.{{ notify_device }}"
    data:
      message: 'There is somebody at the door'
      data:
        tag: '{{ camera }}_{{ id }}'
        group: 'frigate-notification-{{ camera }}'
        image: '/api/frigate/notifications/{{id}}/thumbnail.jpg?format=android' # Android
        attachment: # iOS
          url: '/api/frigate/notifications/{{id}}/thumbnail.jpg'

  - repeat:
      until: "{{ wait.trigger.payload_json['type'] == 'end' }}"
      sequence:
        - wait_for_trigger:
            - platform: mqtt
              topic: frigate/events
              payload: "{{ id }}"
              value_template: "{{ value_json['after']['id'] }}"
          timeout:
            minutes: 2
          continue_on_timeout: false
        - condition: template
          value_template: "{{ wait.trigger.payload_json['type'] == 'end' }}"
        - service: "notify.{{ notify_device }}"
          data:
            message: 'There was somebody at the door'
            data:
              tag: '{{ camera }}_{{ id }}'
              group: 'frigate-notification-{{ camera }}'
              url: '{{base_url}}/api/frigate/notifications/{{id}}/{{camera}}/clip.mp4' # iOS
              clickAction: '{{base_url}}/api/frigate/notifications/{{id}}/{{camera}}/clip.mp4' # Android
              image: '/api/frigate/notifications/{{id}}/thumbnail.jpg?format=android' # Android
              sound: none
              attachment: # iOS
                url: '/api/frigate/notifications/{{id}}/thumbnail.jpg'
                # lazy: true
              actions:
                - action: URI
                  title: View Clip
                  uri: '{{base_url}}/api/frigate/notifications/{{id}}/{{camera}}/clip.mp4'
                - action: URI
                  title: View Snapshot
                  uri: '{{base_url}}/api/frigate/notifications/{{id}}/snapshot.jpg'

  - delay:
      seconds: '{{ cooldown }}'
